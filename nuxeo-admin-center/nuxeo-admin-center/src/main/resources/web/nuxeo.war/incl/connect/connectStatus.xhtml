<div xmlns:h="http://java.sun.com/jsf/html"
  xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxd="http://nuxeo.org/nxweb/document"
  xmlns:c="http://java.sun.com/jstl/core" xmlns:f="http://java.sun.com/jsf/core">
  <a4j:outputPanel id="connectStatusPanel" layout="block">

    <h:panelGroup rendered="#{!registredConnectInstance}">

      <div class="processMessage completeInfo">
          #{messages['connect.message.notregistred']} <a
            href="https://doc.nuxeo.com/x/l4FH" class="connectLink"
            target="NuxeoConnectSite">#{messages['connect.message.discoverconnect']}</a>
      </div>

      <a4j:status>
        <f:facet name="start">
          <h:outputText
            value="#{messages['label.nuxeo.connect.communicating.with.server']}" />
          <h:graphicImage value="/img/standart_waiter.gif" />
        </f:facet>
      </a4j:status>

      <table class="login">
        <tr>
          <td>
            <div class="loginBlock">
              <div class="title">
                <h3>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.onlineRegistration']}" />
                </h3>
              </div>
              <div class="detail">
                <p>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.onlineRegistrationDescription']}" />
                  (<a href="#{nuxeoConnectUrl}../../register"
                    class="connectLink" target="NuxeoConnectSite">#{messages['connect.message.newaccount']}</a>).
                </p>
              </div>
              <div class="body">
                <div class="feedBackMessages">
                  <h:message infoClass="infoMessage" warnClass="warningMessage"
                    errorClass="errorMessage" for="online" id="online" />
                </div>

                <script type="text/javascript">
                  function openInstanceRegistration() {
                    var url = '#{nuxeoConnectUrl}connect/wizardInstanceRegistration/?wizardCallbackUrl=#{baseURL}site/connectClient/registerInstanceCallback?cb=yes';
                    window.open(url, 'instanceRegistrationPopup', 'width=1024,height=768');
                  }
                </script>

                <a4j:form>
                  <a4j:jsFunction name="registerInstanceCallback" reRender="connectStatusPanel">
                    <a4j:actionparam name="param1" assignTo="#{connectStatus.token}"  />
                  </a4j:jsFunction>
                </a4j:form>

                <a href="#" onclick="openInstanceRegistration(); return false;" class="button" target="_blank">Register instance</a>

              </div>
            </div>
          </td>
          <td>
            <div class="loginBlock wide">
              <div class="title">
                <h3>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.offlineRegistration']}" />
                </h3>
              </div>
              <div class="detail">
                <p>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.offlineRegistrationDescription']}" />
                </p>
                <p>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.offlineReg.message1']}" />
                  <a href="#{nuxeoConnectUrl}connect/registerInstance"
                    target="NuxeoConnectSite"> <h:outputText
                      value="#{messages['label.nuxeo.connect.offlineReg.webSite']}" /></a>
                </p>
                <p>
                  <h:outputText styleClass="importantLabel"
                    value="#{messages['label.nuxeo.connect.offlineReg.message2']}" />
                  <br />
                  <h:outputText styleClass="boldLabel"
                    value="#{connectStatus.getCTID()}" />
                </p>
                <p>
                  <h:outputText
                    value="#{messages['label.nuxeo.connect.offlineReg.message3']}" />
                </p>
              </div>
              <div class="body">
                <h:form>
                  <table>
                    <tr>
                      <td class="required"><h:outputText
                          value="#{messages['label.nuxeo.connect.CLID']}" /></td>
                      <td><h:inputText required="true"
                          value="#{connectStatus.CLID}" size="50"
                          id="offline_clid" /></td>
                    </tr>
                    <tr>
                      <td colspan="2"><h:message infoClass="infoMessage"
                          warnClass="warningMessage" errorClass="errorMessage"
                          for="offline_clid" /></td>
                    </tr>
                    <tr>
                      <td></td>
                      <td><a4j:commandButton
                          value="#{messages['action.connect.register']}"
                          styleClass="button"
                          action="#{connectStatus.localRegister}"
                          reRender="connectStatusPanel" /></td>
                    </tr>
                  </table>
                </h:form>
              </div>
            </div>
          </td>
        </tr>
      </table>

    </h:panelGroup>

    <h:panelGroup rendered="#{registredConnectInstance}">


      <c:if test="#{!connectStatus.status.isError()}">

        <div class="processMessage completeSuccess">#{messages['connect.message.registred']}</div>

        <h3>
          <h:outputText
            value="#{messages['label.nuxeo.connect.registration.summary.title']}" />
        </h3>

        <table class="dataTable">
          <tr>
            <td class="labelColumn"><h:outputText
                value="#{messages['label.nuxeo.connect.contractStatus']}" /></td>
            <td id="contractStatus"><h:outputText
                value="#{messages[connectStatus.status.contractStatusLabel]}" />
            </td>
          </tr>
          <tr>
            <td class="labelColumn"><h:outputText
                value="#{messages['label.nuxeo.connect.contractEndDate']}" /></td>
            <td><h:outputText value="#{connectStatus.status.endDate}" styleClass="label label-warning"/></td>
          </tr>
          <tr>
            <td class="labelColumn"><h:outputText
                value="#{messages['label.nuxeo.connect.refreshDate']}" /></td>
            <td><h:form>
                <h:outputText value="#{connectStatus.status.refreshDate.time}">
                  <f:convertDateTime pattern="#{nxu:basicDateAndTimeFormatter()}"
                    timeZone="#{timeZone}" />
                </h:outputText>
                <h:outputText value="&#160;" />
                <a4j:commandButton
                  value="#{messages['action.connect.refreshStatus']}"
                  styleClass="button" action="#{connectStatus.refreshStatus}"
                  reRender="connectStatusPanel" />
              </h:form></td>
          </tr>
          <tr>
            <td class="labelColumn"><h:outputText
                value="#{messages['label.nuxeo.connect.id.CLID']}" /></td>
            <td><h:outputText value="#{connectStatus.registredCLID}" /></td>
          </tr>
          <tr>
            <td class="labelColumn"><h:outputText
                value="#{messages['label.nuxeo.connect.id.CTID']}" /></td>
            <td><h:outputText value="#{connectStatus.getCTID()}" /></td>
          </tr>
          <tr>
            <td class="labelColumn"></td>
            <td><h:form>
                <h:outputText
                  value="#{messages['label.nuxeo.connect.unregister']}" />
                <h:outputText value="&#160;" />
                <a4j:commandButton
                  value="#{messages['action.connect.unregister']}"
                  styleClass="button" action="#{connectStatus.unregister}"
                  reRender="connectStatusPanel" />
              </h:form></td>
          </tr>
        </table>
      </c:if>
      <c:if test="#{connectStatus.status.isError()}">
        <br />
        <div class="processMessage completeWarning">
          #{messages['connect.message.registred.problem']}</div>
        <br />
        <h:form>
          <h:outputText value="&#160;" />
          <a4j:commandButton value="#{messages['action.connect.refreshStatus']}"
            styleClass="button" action="#{connectStatus.refreshStatus}"
            reRender="connectStatusPanel" />
        </h:form>
        <c:if test="#{connectStatus.status.isSecurityError()}">
          <h:outputText value="#{messages['label.nuxeo.connect.securityError']}" />
          <br />
          (<h:outputText value="#{connectStatus.status.errorMessage}" />)
      </c:if>

        <c:if test="#{!connectStatus.status.isSecurityError()}">
          <h:outputText value="#{messages['label.nuxeo.connect.statusError']}" />
          <h:outputText value="#{connectStatus.status.errorMessage}" />
        </c:if>
        <h:form>
          <h:outputText value="#{messages['label.nuxeo.connect.unregister']}" />
          <h:outputText value="&#160;" />
          <a4j:commandButton value="#{messages['action.connect.unregister']}"
            styleClass="button" action="#{connectStatus.unregister}"
            reRender="connectStatusPanel" />
        </h:form>
      </c:if>

    </h:panelGroup>

  </a4j:outputPanel>
</div>
