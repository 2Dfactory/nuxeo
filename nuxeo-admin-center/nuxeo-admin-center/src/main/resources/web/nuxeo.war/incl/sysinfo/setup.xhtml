<div xmlns:h="http://java.sun.com/jsf/html"
  xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxl="http://nuxeo.org/nxforms/layout"
  class="setupPanel">

<script>
  function confirmRestart() {
    return window.confirm("<h:outputText value="#{messages['label.restart.confirm']}" />");
  }
</script>

<a4j:outputPanel id="setupPanel" ajaxRendered="true">

  <c:if test="true">
    <h:outputText value="DEBUG: Configurable: #{configurable}" />
    <br />
    <h:outputText
      value="DEBUG slkdslk: nuxeo.dbtemplate #{setupParams['nuxeo.dbtemplate']}" />
    <a4j:log />
  </c:if>

  <h:panelGroup rendered="#{setupRequiresRestart}">
    <div class="warningFeedback">
      <h:outputText value="#{messages['label.setup.restartNeeded']}" />
      <h:form>
        <h:commandButton onclick="return confirmRestart();"
          action="#{systemInfo.restartServer()}"
          value="#{messages['label.action.restart']}"/>
      </h:form>
    </div>
    <br />
  </h:panelGroup>

  <h:panelGroup rendered="#{!configurable}">
    <div class="warningFeedback">
      <h:outputText value="#{messages['label.setup.notconfigurable']}" />
    </div>
    <br />
  </h:panelGroup>

  <nxu:set var="setupLayoutMode" value="#{nxu:test(configurable, 'edit', 'view')}">

    <a4j:form id="setupForm">

        <nxl:layout name="admin_setup_main" mode="#{setupLayoutMode}"
          value="#{setupParams}" />
        <c:if test="#{setupParams['nuxeo.dbtemplate']!='default'}">
          <nxl:layout name="admin_setup_database" mode="#{setupLayoutMode}"
            value="#{setupParams}" />
        </c:if>

        <nxl:layout name="admin_choose_proxy" mode="#{setupLayoutMode}"
          value="#{setupParams}" />
          -DEBUG #{setupWizardAction.proxyType}-
        <c:if test="#{setupWizardAction.proxyType!='none'}">
          <nxl:layout name="admin_setup_proxy" mode="#{setupLayoutMode}"
            value="#{setupParams}" />
          <c:if test="#{setupWizardAction.proxyType=='authenticated'}">
            <nxl:layout name="admin_setup_proxy_auth" mode="#{setupLayoutMode}"
              value="#{setupParams}" />
          </c:if>
        </c:if>

        <nxl:layout name="admin_setup_mail" mode="#{setupLayoutMode}"
          value="#{setupParams}" />


      <c:if test="#{configurable}">
        <div class="actionBar">
          <a4j:commandButton value="#{messages['action.setup.save']}"
            action="#{setupWizardAction.save()}" reRender="setupPanel"
            styleClass="button"
            onclick="jQuery('html, body').animate({scrollTop:0}, 'slow')" />
          <a4j:commandButton value="#{messages['action.setup.cancel']}"
            action="#{setupWizardAction.resetParameters()}"
            immediate="true"
            reRender="setupPanel" styleClass="button" />
        </div>
      </c:if>

      <nxu:valueHolder
        id="advancedParams_valueHolder"
        var="advancedParamsPanelStatus"
        defaultValue="off">

        <a4j:outputPanel id="advancedParams_panel">

          <c:if test="#{advancedParamsPanelStatus != 'on'}">
            <f:subview>
              <a4j:commandButton
                value="#{messages['adminsubtab.sysinfo.advancedsetup']}"
                reRender="advancedParams_panel"
                immediate="true"
                styleClass="button">
                <f:setPropertyActionListener
                  value="on"
                  target="#{selectionActions.selectedValue}" />
                <f:param name="valueHolderId"
                  value="advancedParams_valueHolder" />
                <nxu:actionListenerMethod
                  value="#{selectionActions.onClick}" />
              </a4j:commandButton>
            </f:subview>
          </c:if>

          <c:if test="#{advancedParamsPanelStatus == 'on'}">

            <h2>
              <h:outputText value="#{messages['adminsubtab.sysinfo.advancedsetup']}" />
            </h2>

            <c:if test="#{configurable}">
              <p>
                <h:outputText styleClass="warningLabel"
                  value="#{messages['label.setup.advancedSearch.warning']}" />
              </p>
            </c:if>

            <table class="dataOutput">
              <c:forEach var="advancedParamKey"
                items="#{advancedParams.keySet().toArray()}">
                <tr>
                  <td class="wideLabel">
                    <h:outputText value="#{advancedParamKey}" />
                  </td>
                  <td id="#{advancedParamKey}">
                    <nxl:widgetType name="text" mode="#{setupLayoutMode}"
                      styleClass="dataInputText" size="100"
                      value="#{advancedParams[advancedParamKey]}" />
                  </td>
                </tr>
              </c:forEach>
            </table>

            <c:if test="#{configurable}">
              <div class="actionBar">
                <a4j:commandButton value="#{messages['action.setup.save']}"
                  action="#{setupWizardAction.save()}" reRender="setupPanel"
                  styleClass="button"
                  onclick="jQuery('html, body').animate({scrollTop:0}, 'slow')" />
                <a4j:commandButton value="#{messages['action.setup.cancel']}"
                  action="#{setupWizardAction.resetParameters()}"
                  immediate="true"
                  reRender="setupPanel" styleClass="button" />
              </div>
            </c:if>

          </c:if>
        </a4j:outputPanel>

      </nxu:valueHolder>

    </a4j:form>
  </nxu:set>

</a4j:outputPanel>
</div>