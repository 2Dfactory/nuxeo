<project name="nuxeo-assembly-2parts"
         default="build"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <artifact:expand depth="3" />

  <property name="outdir" value="${maven.project.build.directory}" />
  <property name="stagedir" value="${outdir}/stage" />

  <target name="build">
    <echo>Building default Nuxeo DM EAR</echo>
    <property name="nuxeo.ear" value="${stagedir}/nuxeo.ear" />
    <mkdir dir="${nuxeo.ear}" />

    <antcall target="build-stateless" />
    <delete failonerror="false" dir="${outdir}/nuxeo.ear-web-stateless" />
    <copy todir="${outdir}/nuxeo-web-stateless.ear">
      <fileset dir="${nuxeo.ear}" />
    </copy>
    <antcall target="build-stateful" />
    <delete failonerror="false" dir="${outdir}/nuxeo.ear-platform-stateful" />
    <copy todir="${outdir}/nuxeo-platform-stateful.ear">
      <fileset dir="${nuxeo.ear}" />
    </copy>

    <nx:profile name="vcs">
      <property name="no-alternate" value="true" />
    </nx:profile>

    <antcall target="build-distribution-stateful">
      <param name="distribution" value="derby" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="mysql" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="postgresql" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="oracle" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="h2" />
    </antcall>

    <!--    <antcall target="clean" />-->
  </target>

  <target name="build-distribution-stateful"
          description="Build stateful distributions on various backends"
          unless="no-alternate">
    <delete failonerror="false"
            dir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear" />
    <copy todir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear"
          overwrite="true">
      <fileset dir="${nuxeo.ear}" />
    </copy>
    <unzip dest="${stagedir}/nuxeo-platform-stateful-${distribution}.ear">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-${distribution}" />
    </unzip>
    <copy todir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear"
          overwrite="true">
      <fileset dir="src/main/resources" />
    </copy>
    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful-${distribution}.zip"
         basedir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful-${distribution}.zip"
                     classifier="platform-stateful-${distribution}"
                     type="zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />
  </target>

  <target name="build-stateful"
          description="Build platform stateful distribution">
    <!-- Nuxeo resources and modules -->
    <delete failonerror="false" dir="${nuxeo.ear}" />
    <unzip dest="${nuxeo.ear}">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-platform-stateful" />
    </unzip>
    <copy todir="${nuxeo.ear}" overwrite="true">
      <!-- Nuxeo DM specific properties -->
      <fileset dir="src/main/resources" />
    </copy>
    <copy todir="${nuxeo.ear}/system" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="org.nuxeo*"
                    category="runtime,jboss4"
                    dependsOnCategory="false" />
          <artifact groupId="org.nuxeo*" category="core,stateful" />
        </includes>
        <excludes>
          <artifact groupId="org.nuxeo.common" />
          <artifact artifactId="nuxeo-generic-wss-handler" />
          <artifact artifactId="nuxeo-platform-audit-facade" />
          <artifact artifactId="nuxeo-platform-placeful-facade" />
          <artifact artifactId="nuxeo-apt-extensions" />
          <artifact artifactId="nuxeo-webengine-apt" />
          <!-- exclude JCR storage -->
          <artifact artifactId="nuxeo-core-jca" />
          <artifact artifactId="nuxeo-core-jcr-connector" />
        </excludes>
      </artifact:set>
    </copy>
    <unzip dest="${nuxeo.ear}/system/nuxeo-platform-audit-facade-${nuxeo.features.version}.jar">
      <artifact:file artifactId="nuxeo-platform-audit-facade" />
    </unzip>
    <unzip dest="${nuxeo.ear}/system/nuxeo-platform-placeful-facade-${nuxeo.services.version}.jar">
      <artifact:file artifactId="nuxeo-platform-placeful-facade" />
    </unzip>

    <!-- Third-party libraries -->
    <antcall target="common-third-party-libraries" />
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <!-- Remote publication lib -->
      <artifact:file groupId="org.apache.httpcomponents"
                     artifactId="httpclient" />
      <artifact:file groupId="org.apache.httpcomponents"
                     artifactId="httpcore" />

      <!-- Needed on platform-stateful ? -->
      <artifact:file groupId="net.sf.ehcache" artifactId="ehcache" />
      <artifact:file groupId="com.google.collections"
                     artifactId="google-collections" />
      <artifact:file groupId="backport-util-concurrent"
                     artifactId="backport-util-concurrent" />
    </copy>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful.zip"
         basedir="${nuxeo.ear}" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="platform-stateful" />
  </target>

  <target name="build-stateless" description="Build web stateless distribution">
    <!-- Nuxeo resources and modules -->
    <delete failonerror="false" dir="${nuxeo.ear}" />
    <unzip dest="${nuxeo.ear}">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-web-stateless" />
    </unzip>
    <copy todir="${nuxeo.ear}" overwrite="true">
      <!-- Nuxeo DM specific properties -->
      <fileset dir="src/main/resources" />
      <artifact:file artifactId="nuxeo-platform-webapp" />
      <artifact:file artifactId="nuxeo-platform-webapp-core" />
    </copy>
    <copy todir="${nuxeo.ear}/system" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="org.nuxeo*"
                    category="runtime,jboss4"
                    dependsOnCategory="false" />
          <artifact groupId="org.nuxeo*" category="stateless" />
        </includes>
        <excludes>
          <artifact groupId="org.nuxeo.common" />
          <artifact artifactId="nuxeo-generic-wss-handler" />
          <artifact artifactId="nuxeo-platform-webapp" />
          <artifact artifactId="nuxeo-platform-webapp-core" />
          <artifact artifactId="nuxeo-apt-extensions" />
          <artifact artifactId="nuxeo-webengine-apt" />
          <!-- exclude JCR storage -->
          <artifact artifactId="nuxeo-core-jca" />
          <artifact artifactId="nuxeo-core-jcr-connector" />
        </excludes>
      </artifact:set>
    </copy>

    <!-- Third-party libraries -->
    <antcall target="common-third-party-libraries" />
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <!-- Needed on web-stateless ? -->
      <artifact:file groupId="com.google.collections"
                     artifactId="google-collections" />
      <artifact:file groupId="backport-util-concurrent"
                     artifactId="backport-util-concurrent" />
    </copy>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-web-stateless.zip"
         basedir="${nuxeo.ear}" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-web-stateless.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="web-stateless" />
  </target>

  <target name="common-third-party-libraries">
    <!-- Common Third-party libraries -->
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <artifact:file groupId="org.osgi" artifactId="osgi-core" />
      <artifact:file groupId="commons-collections"
                     artifactId="commons-collections"
                     version="3.1" />
      <artifact:file groupId="commons-io"
                     artifactId="commons-io"
                     version="1.4" />
      <artifact:file groupId="commons-fileupload"
                     artifactId="commons-fileupload" />
      <artifact:file groupId="commons-beanutils"
                     artifactId="commons-beanutils" />
      <artifact:file groupId="net.sourceforge.cssparser"
                     artifactId="cssparser" />
      <artifact:file groupId="net.sourceforge.nekohtml" artifactId="nekohtml" />
      <artifact:file groupId="org.w3c" artifactId="sac" />
      <artifact:file groupId="net.sf.ehcache"
                     artifactId="ehcache"
                     version="1.5.0" />
      <artifact:file groupId="net.sf.ezmorph" artifactId="ezmorph" />
      <artifact:file groupId="jboss" artifactId="jboss-cache-jdk50" />
      <artifact:file groupId="org.jboss.seam" artifactId="jboss-seam" />
      <artifact:file groupId="org.jboss.seam"
                     artifactId="jboss-seam-remoting" />
      <artifact:file groupId="org.jboss.seam" artifactId="jboss-seam-ui" />
      <artifact:file groupId="org.jboss.seam" artifactId="jboss-seam-mail" />
      <artifact:file groupId="org.jboss.seam" artifactId="jboss-seam-debug" />
      <artifact:file groupId="javax.el" artifactId="el-ri" />
      <artifact:file groupId="org.jboss.el" artifactId="jboss-el" />
      <artifact:file groupId="org.jbpm.jbpm3" artifactId="jbpm-jpdl" />
      <artifact:file groupId="jboss" artifactId="jgroups" />
      <artifact:file groupId="bouncycastle" artifactId="bcmail-jdk14" />
      <artifact:file groupId="bouncycastle" artifactId="bcprov-jdk14" />
      <artifact:file groupId="net.sf.json-lib" artifactId="json-lib" />
      <artifact:file groupId="org.apache.lucene"
                     artifactId="lucene-core"
                     version="2.3.2" />
      <artifact:file groupId="net.sf.opencsv" artifactId="opencsv" />
      <artifact:file groupId="org.codehaus.plexus" artifactId="plexus-utils" />
      <artifact:file groupId="org.slf4j"
                     artifactId="slf4j-api"
                     version="1.5.6" />
      <artifact:file groupId="org.slf4j"
                     artifactId="slf4j-log4j12"
                     version="1.5.6" />
      <artifact:file groupId="org.richfaces.framework"
                     artifactId="richfaces-api"
                     version="3.3.1.GA" />
      <artifact:file groupId="org.richfaces.framework"
                     artifactId="richfaces-impl" />
      <artifact:file groupId="org.richfaces.ui"
                     artifactId="richfaces-ui"
                     version="3.3.1.GA-NX" />
      <artifact:file groupId="org.apache.directory.server"
                     artifactId="apacheds-protocol-shared" />
      <artifact:file groupId="org.apache.directory.shared"
                     artifactId="shared-ldap" />
      <artifact:file groupId="com.sun.facelets" artifactId="jsf-facelets" />
      <!-- Nuxeo-WebEngine fixed libs -->
      <artifact:file groupId="org.codehaus.groovy"
                     artifactId="groovy-all"
                     version="1.5.7" />
      <artifact:file groupId="org.jboss.resteasy" artifactId="resteasy-jaxrs" />
      <artifact:file groupId="org.jboss.resteasy" artifactId="jaxrs-api" />
      <artifact:file groupId="javax.script" artifactId="script-api" />
      <!-- JOD / OOo libs and other converters deps-->
      <artifact:file groupId="com.artofsolving" artifactId="jodconverter" />
      <artifact:file groupId="org.openoffice" artifactId="ridl" />
      <artifact:file groupId="org.openoffice" artifactId="juh" />
      <artifact:file groupId="org.openoffice" artifactId="unoil" />
      <artifact:file groupId="org.openoffice" artifactId="jurt" />
      <artifact:file groupId="com.thoughtworks.xstream"
                     artifactId="xstream"
                     version="1.3.1" />
      <artifact:file groupId="pdfbox" artifactId="pdfbox" />
      <artifact:file groupId="org.fontbox" artifactId="fontbox" />
      <artifact:file groupId="org.jempbox" artifactId="jempbox" />
      <artifact:file groupId="org.restlet" artifactId="org.restlet" />
      <artifact:file groupId="org.wikimodel" artifactId="wem" />
      <artifact:file groupId="jmimemagic" artifactId="jmimemagic" />
      <artifact:file groupId="rome" artifactId="rome" />
      <artifact:file groupId="commons-jexl" artifactId="commons-jexl" />
      <artifact:file groupId="com.hp.hpl.jena" artifactId="arq" />
      <artifact:file groupId="com.noelios.restlet"
                     artifactId="com.noelios.restlet" />
      <artifact:file groupId="com.noelios.restlet"
                     artifactId="com.noelios.restlet.ext.servlet" />
      <artifact:file groupId="com.ibm.icu" artifactId="icu4j" />
      <artifact:file groupId="com.hp.hpl.jena" artifactId="iri" />
      <artifact:file groupId="cup" artifactId="java-cup" />
      <artifact:file groupId="jdom" artifactId="jdom" />
      <artifact:file groupId="com.hp.hpl.jena" artifactId="jena" />
      <artifact:file groupId="joda-time" artifactId="joda-time" />
      <artifact:file groupId="org.restlet"
                     artifactId="org.restlet.ext.fileupload" />
      <artifact:file groupId="oro" artifactId="oro" />
      <artifact:file groupId="org.apache.poi" artifactId="ooxml-schemas" />
      <artifact:file groupId="org.apache.poi" artifactId="poi" />
      <artifact:file groupId="org.apache.poi" artifactId="poi-ooxml" />
      <artifact:file groupId="org.apache.poi" artifactId="poi-scratchpad" />
      <artifact:file groupId="org.apache" artifactId="xmlbeans" />
      <artifact:file groupId="com.sun.xml" artifactId="relaxngDatatype" />
      <artifact:file groupId="com.sun.xml" artifactId="xsom" />
    </copy>
  </target>

  <target name="clean">
    <delete dir="${stagedir}" />
  </target>

</project>
