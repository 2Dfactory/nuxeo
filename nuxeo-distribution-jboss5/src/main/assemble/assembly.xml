<project name="nuxeo-assembly"
         default="build"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />

  <target name="init" unless="init.done">
    <condition property="build.ep">
      <or>
        <isset property="maven.profile.nuxeo-ep" />
        <isset property="maven.profile.all" />
        <isset property="maven.profile.all-distributions" />
      </or>
    </condition>
    <condition property="build.dm">
      <or>
        <isset property="maven.profile.nuxeo-dm" />
        <isset property="maven.profile.all" />
        <isset property="maven.profile.all-distributions" />
      </or>
    </condition>

    <property name="outdir" value="${maven.project.build.directory}" />
    <antcall target="expand" />
    <property name="init.done" value="true" />
  </target>

  <target name="expand" unless="no.build">
    <artifact:nuxeo-expand />
  </target>

  <target name="build" depends="init" unless="no.build">
    <echo>Building JBoss distributions...</echo>
    <property name="jboss" value="${outdir}/jboss.tmp" />

    <antcall target="prepare-jboss" />
    <artifact:attach file="pom.xml"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     type="pom" />
    <antcall target="build-nuxeo-ep-jboss" />
    <antcall target="build-nuxeo-dm-jboss" />

    <delete dir="${jboss}" failonerror="false" />
  </target>

  <target name="prepare-jboss">
    <unzip dest="${outdir}">
      <artifact:resolveFile key="org.jboss:jboss-as:5.1.0.GA:zip" />
      <!--
      <artifact:resolveFile key="org.jboss:jboss-as:5.1.0.GA:zip"
                            classifier="light" />
      <patternset>
        <exclude name="**/bin/classpath.sh" />
        <exclude name="**/bin/run.conf" />
        <exclude name="**/bin/jboss_init*.*" />
        <exclude name="**/bin/probe.*" />
        <exclude name="**/bin/run.sh" />
        <exclude name="**/bin/run.bat" />
        <exclude name="**/bin/shutdown.bat" />
        <exclude name="**/bin/shutdown.sh" />
        <exclude name="**/bin/wsconsume.bat" />
        <exclude name="**/bin/wsconsume.sh" />
        <exclude name="**/bin/wsprovide.bat" />
        <exclude name="**/bin/wsprovide.sh" />
        <exclude name="**/bin/wsrunclient.bat" />
        <exclude name="**/bin/wsrunclient.sh" />
        <exclude name="**/bin/wstools.bat" />
        <exclude name="**/bin/wstools.sh" />
      </patternset>
      -->
    </unzip>
    <move todir="${jboss}">
      <fileset dir="${outdir}/jboss-5.1.0.GA" />
    </move>
    <unzip dest="${jboss}">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-resources:${nuxeo.distribution.version}:zip"
                            classifier="doc" />
    </unzip>
    <copy todir="${jboss}">
      <fileset dir="src/main/resources" />
    </copy>
    <unzip dest="${jboss}/bin">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-resources:${nuxeo.distribution.version}:zip"
                            classifier="bin" />
    </unzip>
    <chmod dir="${jboss}/bin" perm="ug+x" includes="*.sh,*ctl,*.command" />

    <unzip dest="${jboss}/templates">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-resources:${maven.project.version}:zip"
                            classifier="templates-jboss5" />
    </unzip>

    <!-- shouldn't the unzip make these 2 jars? -->
    <copy todir="${jboss}/server/default/deploy/nuxeo.ear/bundles">
      <artifact:resolveFile key="org.nuxeo.common:nuxeo-common" />
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-runtime-deploy" />
    </copy>
    <copy todir="${jboss}/server/default/deployers">
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-jboss-deployer:5.1.0.GA" />
    </copy>

  </target>

  <target name="build-nuxeo-ep-jboss"
          if="build.ep"
          description="Build JBoss distribution with Nuxeo EP">

    <delete failonerror="false"
            dir="${outdir}/nuxeo-ep-${maven.project.version}-jboss" />
    <copy todir="${outdir}/nuxeo-ep-${maven.project.version}-jboss">
      <fileset dir="${jboss}" />
    </copy>
    <chmod dir="${outdir}/nuxeo-ep-${maven.project.version}-jboss/bin"
           perm="ug+x"
           includes="*.sh,*ctl,*.command" />
    <!-- Nuxeo EP EAR -->
    <unzip dest="${outdir}/nuxeo-ep-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${nuxeo.features.version}:zip" />
    </unzip>

    <!-- add JBossWS specific bundle -->
    <copy todir="${outdir}/nuxeo-ep-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/bundles">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ws-jbossws:${nuxeo.features.version}" />
    </copy>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-ep.zip"
         basedir="${outdir}"
         includes="nuxeo-ep-${maven.project.version}-jboss/**" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-ep.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="nuxeo-ep"
                     type="zip" />
  </target>

  <target name="build-nuxeo-dm-jboss"
          if="build.dm"
          description="Build JBoss distribution with Nuxeo DM">

    <delete failonerror="false"
            dir="${outdir}/nuxeo-dm-${maven.project.version}-jboss" />
    <copy todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss">
      <fileset dir="${jboss}" />
    </copy>
    <chmod dir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/bin"
           perm="ug+x"
           includes="*.sh,*ctl,*.command" />
    <!-- Nuxeo DM EAR -->
    <unzip dest="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-dm:${nuxeo.distribution.version}:zip" />
    </unzip>

    <!-- add JBossWS specific bundle -->
    <copy todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/bundles">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ws-jbossws:${nuxeo.features.version}" />
    </copy>

    <!-- WSS specific BEGIN -->
    <!-- install WSS root filter as external lib  -->
    <copy todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/lib">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-generic-wss-handler:${nuxeo.features.version}" />
    </copy>

    <!-- move WSS deps outside of Nuxeo ear -->
     <move todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/lib">
      <fileset dir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/lib" >
        <include name="freemarker*" />
        <include name="commons-lang*" />
      </fileset>
    </move>

    <!-- add WSS filter binding in ROOT.WAR -->
    <move tofile="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/ROOT.war/WEB-INF/web.xml"
          file="${outdir}/nuxeo-dm-${maven.project.version}-jboss/templates/default/wss-rootweb.xml" />

    <!-- WSS specific END -->

    <!-- remove unwanted libs alreaduy provided by jboss -->
    <delete failonerror="false">
      <fileset dir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/lib">
        <exclude name="jboss-seam*" />
        <include name="jboss*" />
        <include name="hibernate*" />
        <include name="javaassist*" />
        <include name="commons-collections*" />
        <include name="commons-logging*" />
        <include name="geronimo-*" />
        <include name="jta-*" />
        <include name="log4j-*" />
        <include name="persistence-*" />
        <include name="servlet-api-*" />
        <include name="script-api-*" />
        <include name="jca-api-*" />
        <include name="el-*" />
        <!-- TODO should we removed the following? -->
        <!--
        <include name="javacc-*" />
        <include name="jaxb-api-*" />
        <include name="jaxen-*" />
        <include name="osgi-core-*" />
        <include name="webservices-api-*" />
        -->
      </fileset>
    </delete>

    <copy todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/lib">
      <artifact:file groupId="org.apache.derby" artifactId="derby" />
      <artifact:file groupId="org.jboss.el" artifactId="jboss-el" />
      <artifact:file groupId="commons-el" artifactId="commons-el" />
    </copy>

    <move todir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/lib">
		<fileset dir="${outdir}/nuxeo-dm-${maven.project.version}-jboss/server/default/deploy/nuxeo.ear/lib">
   		  <include name="**/derby-*.jar"/>
		</fileset>
    </move>

    <!-- Complementary JBoss templates for DM -->
    <unzip dest="${outdir}/nuxeo-dm-${maven.project.version}-jboss/templates">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-resources:${maven.project.version}:zip"
                            classifier="templates-jboss5" />
    </unzip>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-dm.zip"
         basedir="${outdir}"
         includes="nuxeo-dm-${maven.project.version}-jboss/**" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-dm.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="nuxeo-dm"
                     type="zip" />
  </target>

</project>
