<project name="integration-tests"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <taskdef resource="net/sf/antcontrib/antlib.xml" />

  <property name="out.dir" value="${maven.project.build.directory}" />
  <property name="nuxeo.home" value="${out.dir}/tomcat" />
  <property name="classifier" value="nuxeo-cap" />

  <unzip dest="${out.dir}/" overwrite="false">
    <artifact:resolveFile key="org.nuxeo:nuxeo-ftest::zip" />
  </unzip>
  <import file="${out.dir}/nuxeo-ftest.xml" />

  <target name="prepare-environment"
          depends="prepare-db,prepare-tomcat,wizard-on">

    <!-- retrieve DM MP package -->
    <copy todir="${maven.project.build.directory}">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-marketplace-dm::zip" />
    </copy>
    <!-- compute MD5 -->
    <checksum file="${maven.project.build.directory}/nuxeo-marketplace-dm-${nuxeo.distribution.version}.zip" property="DMMPMD5"/>
    <!-- rename the MP file -->
    <move file="${maven.project.build.directory}/nuxeo-marketplace-dm-${nuxeo.distribution.version}.zip"
    tofile="${maven.project.build.directory}/tomcat/setupWizardDownloads/${DMMPMD5}" />

    <!-- Build Virtual package -->
    <zip destfile="${maven.project.build.directory}/nuxeo-content-browser-${nuxeo.distribution.version}.zip">
        <fileset dir="src/main/resources/content-browser"/>
    </zip>
    <!-- compute MD5 -->
    <checksum file="${maven.project.build.directory}/nuxeo-content-browser-${nuxeo.distribution.version}.zip" property="VPCBMPMD5"/>
    <!-- rename the MP file -->
    <move file="${maven.project.build.directory}/nuxeo-content-browser-${nuxeo.distribution.version}.zip"
        tofile="${maven.project.build.directory}/tomcat/setupWizardDownloads/${VPCBMPMD5}" />

    <copy file="src/main/resources/packages.xml" tofile="${maven.project.build.directory}/tomcat/setupWizardDownloads/packages.xml" >
      <filterset>
        <filter token="DMMPMD5" value="${DMMPMD5}"/>
        <filter token="VPCBMPMD5" value="${VPCBMPMD5}"/>
      </filterset>
    </copy>

  </target>

</project>
