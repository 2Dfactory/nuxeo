<?xml version="1.0"?>
<project name="nuxeo-assembly"
         default="package"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <!-- Properties -->
  <property file="build.properties" />
  <property name="jboss.config" value="default" />
  <property name="jboss.dir" value="/opt/jboss" />
  <property name="project.build.directory" value="target" />

  <condition property="osfamily-macosx">
    <and>
      <os family="mac" />
      <os family="unix" />
    </and>
  </condition>
  <condition property="osfamily-unix">
    <and>
      <os family="unix" />
      <not>
        <os family="mac" />
      </not>
    </and>
  </condition>
  <condition property="osfamily-windows">
    <os family="windows" />
  </condition>

  <target name="package"
          depends="package-macosx,package-unix,package-windows" />
  <target name="package-macosx" if="osfamily-macosx">
    <property name="installer.path"
              value="${user.home}/.wine/drive_c/workspace/tools/win32Installer" />
    <property name="istool.path"
              value="${user.home}/.wine/drive_c/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false" />
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <copy todir="${installer.path}" overwrite="true">
      <fileset dir="src/main/resources/win32Installer" />
    </copy>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="/Applications/Darwine/Wine.bundle/Contents/bin/wine"
          failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="/Applications/Darwine/Wine.bundle/Contents/bin/wine"
          failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>
  <target name="package-unix" if="osfamily-unix">
    <property name="installer.path"
              value="${user.home}/.wine/drive_c/workspace/tools/win32Installer" />
    <property name="istool.path"
              value="${user.home}/.wine/drive_c/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false" />
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <copy todir="${installer.path}" overwrite="true">
      <fileset dir="src/main/resources/win32Installer" />
    </copy>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="wine" failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="wine" failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="package-windows" if="osfamily-windows">
    <property name="installer.path" value="C:/workspace/tools/win32Installer" />
    <property name="istool.path" value="C:/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false" />
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <copy todir="${installer.path}" overwrite="true">
      <fileset dir="src/main/resources/win32Installer" />
    </copy>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="${istool.path}/ISTool.exe" failonerror="true">
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="${istool.path}/ISTool.exe" failonerror="true">
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="prepare">
    <unzip dest="${installer.path}">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:win32installer-resources:${win32installer.version}:zip" />
    </unzip>
    <unzip dest="${project.build.directory}/nuxeo-jboss">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-jboss:${nuxeo.distribution.version}:zip"
                            classifier="${distribution}" />
    </unzip>
    <unzip dest="${project.build.directory}/nuxeo-shell">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-shell:${nuxeo.distribution.version}:zip"  />
    </unzip>
    <delete dir="${installer.path}/jboss/NuxeoServer" />
    <move file="${project.build.directory}/nuxeo-jboss/nuxeo-dm-jboss"
          tofile="${installer.path}/jboss/NuxeoServer" />
    <delete dir="${installer.path}/nxshell/NuxeoShell/" />
    <move file="${project.build.directory}/nuxeo-shell/nxshell"
          tofile="${installer.path}/nxshell/NuxeoShell" />
  </target>
  <target name="retrieve">
    <move todir="${project.build.directory}">
      <fileset dir="${installer.path}/script/Output/">
        <include name="*.exe" />
      </fileset>
    </move>
    <artifact:attach file="${project.build.directory}/nuxeo-dm-5.3.0-GA-setup.exe"
                     classifier="${distribution}"
                     type="exe"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />
    <artifact:attach file="${project.build.directory}/nuxeo-dm-5.3.0-GA_64-setup.exe"
                     classifier="${distribution}_64"
                     type="exe"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />
  </target>
</project>
