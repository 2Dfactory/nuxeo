<?xml version="1.0"?>
<project name="nuxeo-assembly"
         default="package"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <!-- Properties -->
  <property name="project.build.directory" value="target" />

  <condition property="osfamily-macosx">
    <and>
      <os family="mac" />
      <os family="unix" />
    </and>
  </condition>
  <condition property="osfamily-unix">
    <and>
      <os family="unix" />
      <not>
        <os family="mac" />
      </not>
    </and>
  </condition>
  <condition property="osfamily-windows">
    <os family="windows" />
  </condition>

  <target name="package"
          depends="package-macosx,package-unix,package-windows" />
  <target name="package-macosx" if="osfamily-macosx">
    <property name="scripts.path" value="src/main/resources" />
    <property name="msbuild.path"
              value="${user.home}/.wine/drive_c/Program Files/Framework 3.0" />
    <echo message="Running MSBuild with Wine..." />
    <exec executable="/Applications/Darwine/Wine.bundle/Contents/bin/wine"
          failonerror="true">
      <arg value="${msbuild.path}/MSBuild.exe" />
      <arg value="${scripts.path}/NuxeoManager.sln" />
    </exec>
    <antcall target="retrieve" />
  </target>
  <target name="package-unix" if="osfamily-unix">
    <property name="scripts.path" value="src/main/resources" />
    <property name="msbuild.path"
              value="${user.home}/.wine/drive_c/Program Files/Framework 3.0" />
    <echo message="Running MSBuild with Wine..." />
    <exec executable="wine" failonerror="true">
      <arg value="${msbuild.path}/MSBuild.exe" />
      <arg value="${scripts.path}/NuxeoManager.sln" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="package-windows" if="osfamily-windows">
    <property name="scripts.path" value="src/main/resources" />
    <property name="msbuild.path"
              value="${user.home}/.wine/drive_c/Program Files/Framework 3.0" />
    <echo message="Running MSBuild with Wine..." />
    <exec executable="${msbuild.path}/MSBuild.exe" failonerror="true">
      <arg value="${scripts.path}/NuxeoManager.sln" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="retrieve">
    <!-- TODO NXP-4948 deploy produced artifacts
    <move todir="${project.build.directory}">
      <fileset dir="${scripts.path}/NuxeoCtl/.../Debug/">
        <include name="*.exe" />
      </fileset>
    </move>
    <artifact:attach file="${project.build.directory}/NuxeoCtl.exe"
                     classifier="${distribution}"
                     type="exe"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />
    -->
  </target>
</project>
