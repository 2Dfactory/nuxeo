<link rel="import" href="../../../bower_components/paper-styles/paper-styles.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-connection.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-resource.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/nx-doc-resource.html"></link>
<link rel="import" href="../../../bower_components/nuxeo-elements/popup-confirm.html"></link>
<link rel="import" href="../../../bower_components/paper-button/paper-button.html"></link>
<link rel="import" href="../../../bower_components/paper-input/paper-input.html"></link>
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html"></link>
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html"></link>
<link rel="import" href="../../../permissions/components/popup-permission/popup-permission.html"></link>

<dom-module id="document-permissions">
    <template>
        <nx-doc-resource id="doc" auto="true" doc-id="{{docId}}" doc-path="{{docPath}}" response="{{doc}}"
            enrichers="extendedAcls, permissions, userVisiblePermissions"></nx-doc-resource>

        <div class="bubbleBox">
            <div class="bubbleHeader">
                <h3>Permissions defined locally</h3>
                <template is="dom-if" if="{{hasEverythingRight}}">
                    <popup-permission doc-id="{{doc.uid}}" user-visible-permissions="{{doc.contextParameters.userVisiblePermissions}}"
                        on-acecreated="refresh"></popup-permission>
                </template>
            </div>
            <template is="dom-if" if="{{hasLocalAces}}">
                <div>
                    <table class="dataTable tmp-tab">
                        <tr class="tmp-tab">
                            <th class="tmp-tab">User / Group</th>
                            <th class="tmp-tab">Right</th>
                            <th class="tmp-tab">Time frame</th>
                            <th class="tmp-tab">Granted By</th>
                            <th class="tmp-tab">Actions</th>
                        </tr>
                        <template is="dom-repeat" items="{{localAces}}" as="ace">
                            <tr>
                                <td><span>{{ace.username}}</span></td>
                                <td><span>{{ace.permission}}</span></td>
                                <td><span>{{formatTimeFrame(ace)}}</span></td>
                                <td><span>{{ace.creator}}</span></td>
                                <td>
                                    <template is="dom-if" if="{{hasEverythingRight}}">
                                        <popup-permission doc-id="{{doc.uid}}" ace="{{ace}}" user-visible-permissions="{{doc.contextParameters.userVisiblePermissions}}"
                                            on-aceupdated="refresh"></popup-permission>
                                        <paper-icon-button icon="delete" on-click="localRightsDel" raised="true"></paper-icon-button>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
            </template>
            <template is="dom-if" if="{{!hasLocalAces}}">
                <p class="emptyResult">No local permission.</p>
            </template>
        </div>

        <template is="dom-if" if="{{hasInheritedAces}}">
            <div class="bubbleBox">
                <div class="bubbleHeader">
                    <h3>Permissions inherited from upper levels</h3>
                    <paper-button id="block" raised="true" on-click="blockInheritance">Block</paper-button>
                    <paper-tooltip for="block">Block tooltip</paper-tooltip>
                </div>
                <div>
                    <table class="dataTable tmp-tab">
                        <tr class="tmp-tab">
                            <th class="tmp-tab">User / Group</th>
                            <th class="tmp-tab">Right</th>
                            <th class="tmp-tab">Time frame</th>
                            <th class="tmp-tab">Granted By</th>
                        </tr>
                        <template is="dom-repeat" items="{{inheritedAces}}" as="ace">
                            <tr>
                                <td><span>{{ace.username}}</span></td>
                                <td><span>{{ace.permission}}</span></td>
                                <td><span>{{formatTimeFrame(ace)}}</span></td>
                                <td><span>{{ace.creator}}</span></td>
                            </tr>
                        </template>
                    </table>
                </div>
            </div>
        </template>

        <template is="dom-if" if="{{!hasInheritedAces}}">
            <div class="bubbleBox">
                <div class="bubbleHeader">
                    <h3>Permissions inherited from upper levels</h3>
                    <paper-button raised="true" on-click="unblockInheritance">Unblock</paper-button>
                    <paper-tooltip for="block">Unblock tooltip</paper-tooltip>
                </div>
                <div>
                    <p class="emptyResult"></p>
                </div>
            </div>
        </template>

        <popup-confirm id="confirmation">
            <h2>The following permission will be deleted</h2>
            <p>METTRE LA LIGNE DU TABLEAU</p>
        </popup-confirm>

        <nx-operation id="rmPermission" op="Document.RemovePermission" input="{{doc.uid}}" on-response="refresh"></nx-operation>
        <nx-operation id="blockOp" op="Document.BlockPermissionInheritance" input={{docId}}
            on-response="refresh"></nx-operation>
        <nx-operation id="unblockOp" op="Document.UnblockPermissionInheritance" input={{docId}}
            on-response="refresh"></nx-operation>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'document-permissions',

        properties: {
            doc: {
                type: Object,
                value: null
            },
            docId: {
                type: String,
                value: ''
            },
            docPath: {
                type: String,
                value: ''
            },
            hasEverythingRight: {
                type: Boolean,
                value: false,
                computed: 'computeEverythingRight(doc)'
            },
            hasLocalAces: {
                type: Boolean,
                value: false,
                computed: 'computeHasLocalAces(doc)'
            },
            hasInheritedAces: {
                type: Boolean,
                value: false,
                computed: 'computeHasInheritedAces(doc)'
            },
            localAces: {
                type: Array,
                value: [],
                computed: 'computeLocalAces(doc)'
            },
            inheritedAces: {
                type: Array,
                value: [],
                computed: 'computeInheritedAces(doc)'
            }
        },

        refresh: function() {
            document.querySelector('#doc').get();
        },

        formatTimeFrame: function(ace) {
            var now = moment();
            var begin = ace.begin;
            var end = ace.end;
            var format = 'D MMM YYYY';

            if (begin !== null && end === null) {
                return (now.isAfter(begin) ? 'Since ' : 'From ') + moment(begin).format(format);
            } else if (begin === null && end !== null) {
                return 'Until ' + moment(end).format(format);
            } else if (begin !== null && end != null) {
                return (now.isAfter(begin) ? 'Since ' : 'From ') + moment(begin).format(format) + ' until ' + moment(end).format(format);
            } else {
                return 'Permanent';
            }
        },

        localRightsDel: function(e, i) {
            var self = this;
            this.$.confirmation.toggle(function() {
                // Walk on data hosts in order to retrieve the 'item' property from the repeat loop item context
                var item = e.model.dataHost.dataHost.ace;
                self.$.rmPermission.params = {
                    id: item.id
                };
                self.$.rmPermission.execute();
            });
        },

        computeEverythingRight: function(doc) {
            if (doc) {
                return doc.contextParameters.permissions.indexOf('Everything') !== -1;
            }
            return false;
        },

        computeHasLocalAces: function(doc) {
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name !== 'inherited' && acls.length >= 1) {
                        return true;
                    }
                }
            }
            return false;
        },

        computeHasInheritedAces: function(doc) {
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name === 'inherited') {
                        return true;
                    }
                }
            }
            return false;
        },

        computeLocalAces: function(doc) {
            var localAces = [];
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    var acl = acls[i];
                    if (acl.name !== 'inherited') {
                        for (var j = 0; j < acl.ace.length; j++) {
                            var ace = acl.ace[j];
                            if (ace.granted && (ace.status === 'pending' || ace.status === 'effective')) {
                                ace.aclName = acl.name;
                                localAces.push(ace);
                            }
                        }
                    }
                }
            }
            localAces.sort(this._sortAces);
            return localAces;
        },

        computeInheritedAces: function(doc) {
            var inheritedAces = [];
            if (doc) {
                var acls = doc.contextParameters.acls;
                for (var i = 0; i < acls.length; i++) {
                    if (acls[i].name === 'inherited') {
                        var acl = acls[i];
                        for (var j = 0; j < acl.ace.length; j++) {
                            var ace = acl.ace[j];
                            if (ace.granted && (ace.status === 'pending' || ace.status === 'effective')) {
                                inheritedAces.push(ace);
                            }
                        }
                    }
                }
            }
            inheritedAces.sort(this._sortAces);
            return inheritedAces;
        },

        _sortAces: function(a, b) {
            // -1 => a before b
            // 1 -> a after b
            if (a.begin === null) {
                return -1;
            } else if (b.begin === null) {
                return 1;
            } else {
                // compare begin dates
                var aBegin = moment(a.begin);
                var bBegin = moment(b.begin);
                return aBegin.isBefore(bBegin) ? -1 : 1;
            }
        },

        blockInheritance: function() {
            this.$.blockOp.execute();
        },

        unblockInheritance: function() {
            this.$.unblockOp.execute();
        }
    });
</script>
