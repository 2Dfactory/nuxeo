<ui:composition
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:nxh="http://nuxeo.org/nxweb/html"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html">

<nxu:set var="fancyboxId"
  value="#{idPrefix}#{action.id}"
  cache="true">

<nxu:set var="include"
  value="#{action.properties.include}"
  resolveTwice="true" cache="true">
<nxu:set var="iframe"
  value="#{action.properties.iframe}"
  resolveTwice="true" cache="true">

  <a4j:outputPanel id="#{fancyboxId}_ajax_panel">

    <nxu:set var="addForm"
      value="#{action.properties.requireSurroundingForm}"
      resolveTwice="true" cache="true">
      <c:if test="#{clickedActionId == action.id and not addForm}">
        <script>
          showFancyBox('##{fancyboxId}_box');
        </script>
        <div style="display:none">
          <div id="#{fancyboxId}_box">
            <ui:include src="#{include}" />
          </div>
        </div>
      </c:if>

      <c:if test="#{addForm}">
        <nxu:set var="fancyboxFormId"
          value="#{fancyboxId}_form"
          cache="true">
        <nxu:set
          var="actionClicked"
          value="#{clickedActionId == action.id or nxu:hasMessages(fancyboxFormId)}">
        <nxu:set var="elementsToReRender"
          value="#{action.properties.reRender}"
          resolveTwice="true" cache="true">

          <c:if test="#{actionClicked}">
            <script>
              jQuery('<a href="##{fancyboxId}_box"></a>').fancybox({
                'autoDimensions': false,
                'autoScale': true,
                'width': 'auto',
                'height': '320',
                'transitionIn': 'none',
                'transitionOut': 'none',
                'enableEscapeButton': true,
                'centerOnScroll': true,
                'scrolling': 'auto'}).click();
              jQuery('##{fancyboxId}_form').focusFirst();
            </script>
          </c:if>

          <div style="display:none">
            <div id="#{fancyboxId}_box">
              <nxu:set var="useAjaxForm"
                value="#{action.properties.useAjaxForm}"
                resolveTwice="true" cache="true">

                <c:if test="#{useAjaxForm}">
                  <a4j:form id="#{fancyboxFormId}"
                    ajaxSubmit="true"
                    reRender="#{elementsToReRender},#{fancyboxId}_ajax_panel"
                    ignoreDupResponses="true"
                    requestDelay="100"
                    eventsQueue="#{eventsQueueId}"
                    onsubmit="removeAllTinyMCEEditors(); return true;"
                    oncomplete="jQuery.fancybox.close();">
                    <ui:include src="#{include}" />
                  </a4j:form>
                </c:if>

                <c:if test="#{not useAjaxForm}">
                  <h:form id="#{fancyboxFormId}"
                    enctype="multipart/form-data"
                    onsubmit="jQuery.fancybox.close();">
                    <ui:include src="#{include}" />
                  </h:form>
                </c:if>

              </nxu:set>
            </div>
          </div>

        </nxu:set>
        </nxu:set>
        </nxu:set>
      </c:if>

    </nxu:set>

  </a4j:outputPanel>

</nxu:set>
</nxu:set>

</nxu:set>

</ui:composition>